from fastapi.testclient import TestClient
from main import app
import json

client = TestClient(app)

# Step 1: Login to get fresh token
login_data = {"phone": "mmmm", "password": "mmmm"}
login_resp = client.post("/auth/login/restaurant", json=login_data)
assert login_resp.status_code == 201

access_token = login_resp.cookies.get("access_token")  # key point
print("Access token:", access_token)

# Step 2: Send menu_add request with token as cookie
menu_json = {
    "name": "Paneer Butter Masala",
    "category": "Main Course",
    "description": "Tasty paneer dish",
    "price": 250,
    "currency": "INR",
    "is_veg": True,
    "stock": 10,
    "is_available": True
}

with open("test_image.jpg", "rb") as img:
    resp = client.post(
        "/restaurant/menu/add",
        data={"menu": json.dumps(menu_json)},
        files={"image": ("test_image.jpg", img, "image/jpeg")},
        cookies={"access_token": access_token}  # must match cookie name
    )

print(resp.status_code)
print(resp.json())
